<style>

	#ticket.lms-ui-box-container .lms-ui-box-row-label {
		min-width: 12em;
	}

	#ticket.lms-ui-box-container .lms-ui-box-row.categories .lms-ui-box-row-field {
		flex-wrap: wrap;
	}

	#requestor.lms-ui-box-row-field {
		flex-direction: column !important;
		align-items: flex-start !important;
	}

	.ticket-list-container .lms-ui-box-row-field {
		align-items: flex-start !important;
	}

	.ticket-list-container ul {
		display: inline;
		list-style: none;
		padding: 0;
		margin-block-start: 0;
		margin-block-end: 0.5em;
	}

	.ticket-list-container li .ticket-unlink {
		visibility: hidden;
/*
		margin-left: -1.5em;
 */
		margin-top: 0.1em;
		padding-right: 0.4em;
	}

	.ticket-list-container li:hover .ticket-unlink {
		 visibility: visible;
		 cursor: pointer;
	}

	.ticket-suggestion-container .ticket-suggestion-button {
		cursor: pointer;
	}

	.ticket-suggestion-container .ticket-suggestion:not(:focus) {
		display: none;
	}

</style>

{box_container id="ticket"}
	{box_header multi_row=true}
		{box_header icon="img/ticket.gif" label="Subject:"}
			<INPUT type="text" size="50" name="ticket[subject]" value="{$ticket.subject|escape}" {tip text="Enter subject" trigger="subject"}>
		{/box_header}
		{box_header icon="img/service-type.png" label="Service type:"}
			<SELECT name="ticket[service]" {if ConfigHelper::checkConfig('rt.ticket_service_required')}required {tip text="Choose service type" trigger="service"}>
					<OPTION value="" selected hidden>{trans("select")}</OPTION>{else}>{/if}
				{foreach $_SERVICETYPES as $key => $service}
					<OPTION value="{$key}"{if $key == $ticket.service} selected{/if}>{$service}</OPTION>
				{/foreach}
			</SELECT>
		{/box_header}
		{box_header icon="img/ticket-type.png" label="Ticket type:"}
			<SELECT name="ticket[type]" {if ConfigHelper::checkConfig('rt.ticket_type_required')}required {tip text="Choose ticket type" trigger="type"}>
					<OPTION value="" selected hidden>{trans("select")}</OPTION>{else}>{/if}
				{foreach $_RT_TYPES as $key => $type}
					<OPTION value="{$key}"{if $key == $ticket.type} selected{/if}>{$type.label}</OPTION>
				{/foreach}
			</SELECT>
		{/box_header}
	{/box_header}

	{box_contents}
		{box_panel}
			{block name="rtticketmodify-leftcolumn"}
			{if $layout.module != 'eventadd'}
			{box_row icon="img/customer.gif" label="Customer:"}
				{$customer_selector='[name=&quot;ticket[custid]&quot;]'}
				{$address_selector='[name=&quot;ticket[address_id]&quot;]'}
				{customerlist form="ticket" customers=$customerlist selected=$customerid selectname="ticket[customerid]" inputname="ticket[custid]" selecttip="Select customer from list or enter his data if is not a customer" customOnChange="change_customer('{$customer_selector}', '{$address_selector}');"}
			{/box_row}
			{/if}

			{box_row icon="img/users.gif" label="Requestor:" field_id="requestor"}
				<div class="lms-ui-box-row">
					<SELECT name="ticket[requestor_userid]" {tip text="Select requestor from list" trigger="requestor_userid"}>
						<option value="">{trans("<!person>- none -")}</option>
						<option value="0"{if $ticket.requestor_userid == '0'} selected{/if}>{trans("- indicated person -")}</option>
						{foreach $userlist as $user}
							<option value="{$user.id}"{if $ticket.requestor_userid == $user.id} selected{/if}>{$user.rname}</option>
						{/foreach}
					</SELECT>
				</div>
				<div class="lms-ui-box-row indicated-person">
					<div class="lms-ui-box-row-label">
						{trans("Name:")}
					</div>
					<div class="lms-ui-box-row-field">
						<INPUT type="text" name="ticket[requestor_name]" id="requestor_name" value="{$ticket.requestor_name}" {tip trigger="requestor_name"}>
					</div>
				</div>
				<div class="lms-ui-box-row indicated-person">
					<div class="lms-ui-box-row-label">
						{trans("E-mail:")}
					</div>
					<div class="lms-ui-box-row-field">
						<INPUT type="text" name="ticket[requestor_mail]" id="requestor_mail" value="{$ticket.requestor_mail}" {tip trigger="requestor_mail"}>
					</div>
				</div>
				<div class="lms-ui-box-row indicated-person">
					<div class="lms-ui-box-row-label">
						{trans("Phone:")}
					</div>
					<div class="lms-ui-box-row-field">
						<INPUT type="text" name="ticket[requestor_phone]" id="requestor_phone" value="{$ticket.requestor_phone}" {tip trigger="requestor_phone"}>
					</div>
				</div>
			{/box_row}

{if $layout.module == 'rtticketadd'}
			{box_row icon="img/docum.gif" label="Message template:" field_id="message-templates" id="message-template-row"
				visible=!empty($messagetemplates)}
				{include file="rt/rtmessagetemplates.html" templates=$messagetemplates tip="Select message template"
					target='[name="ticket[body]"]'}
			{/box_row}

			{block name="rtticketadd-content"}
			{box_row icon="img/mail.gif" label="Content:"}
				<TEXTAREA name="ticket[body]" cols="50" rows="5" {tip text="Enter ticket content" trigger="body"} >{$ticket.body}</TEXTAREA>
			{/box_row}
			{/block}

			{box_row icon="img/docum.gif" label="Note template:" field_id="note-templates" id="note-template-row"
				visible=!empty($notetemplates)}
				{include file="rt/rtmessagetemplates.html" templates=$notetemplates tip="Select note template"
					target='[name="ticket[note]"]'}
			{/box_row}

			{box_row icon="img/note.gif" label="Note:"}
				<TEXTAREA name="ticket[note]" cols="50" rows="5" {tip text="Enter ticket content" trigger="body"}>{$ticket.note}</TEXTAREA>
			{/box_row}

			{box_row icon="img/attach.gif" label="Attachments:"}
				{fileupload id="files" fileupload=$fileupload form="ticket-form"}
			{/box_row}
{/if}

			{box_row icon="img/queue.gif" label="Categories:" class="categories"}
				{if ConfigHelper::checkConfig('phpui.helpdesk_allow_empty_categories')}
				<input type="hidden" name="ticket[categorywarn]" value="{$ticket.categorywarn}">
				{/if}
				{include file="rt/rtcategoryselection.html" categories=$categories name_prefix="ticket[categories]"}
			{/box_row}

			{box_row icon="img/mail.gif" label="Notify users:" labelid="notify"}
				<INPUT type="checkbox" name="ticket[notify]" id="notify" value="1"{if $ticket.notify} CHECKED{/if}>
			{/box_row}
			{/block}
		{/box_panel}
		{box_panel}
			{block name="rtticketmodify-rightcolumn"}
			{box_row icon="img/users.gif" label="Owner:"}
				<SELECT size="1" name="ticket[owner]" {tip text="Select user" trigger="owner"}>
					<OPTION value="0">- {trans("select user")} -</OPTION>
					{foreach $userlist as $user}
						{if !ConfigHelper::checkConfig('phpui.helpdesk_hide_disabled_users')
						|| (ConfigHelper::checkConfig('phpui.helpdesk_hide_disabled_users') && $user.access)
						|| $user.id == $ticket.owner}
							<OPTION value="{$user.id}"{if !$user.access} class="blend"{/if}{if $user.id == $ticket.owner} selected{/if}>{$user.rname}</OPTION>
						{/if}
					{/foreach}
				</SELECT>
				&nbsp;
				<label>
					<input type="checkbox" id="assign-to-me" data-userid="{$layout.logid}">
					{trans("assign to me")}
				</label>
			{/box_row}

			{box_row icon="img/verifier.png" label="Verifier:" field_id="rtverifiers"}
				{if $layout.module != 'rtticketedit' || !$ticket.oldverifierid || $ticket.oldverifierid == $layout.logid}
					<SELECT size="1" name="ticket[verifierid]" {tip text="Select user" trigger="verifierid"}>
						<OPTION value="">- {trans("select user")} -</OPTION>
						{foreach $userlist as $user}
							{if !ConfigHelper::checkConfig('phpui.helpdesk_hide_disabled_users')
							|| (ConfigHelper::checkConfig('phpui.helpdesk_hide_disabled_users') && $user.access)
							|| $user.id == $ticket.verifierid}
								<OPTION value="{$user.id}"{if $user.id == $ticket.verifierid} selected{/if}{if !$user.access} class="blend"{/if}>{$user.rname}</OPTION>
							{/if}
						{/foreach}
					</SELECT>
				{else}
					<input type="hidden" name="ticket[verifierid]" value="{$ticket.oldverifierid}">
					<span title="{trans("Only verifier can change this")}">{$ticket.verifier_username}</span>
				{/if}
			{/box_row}

			{box_row icon="img/calendar.gif" label="<!rt>Deadline:"}
				{if $layout.module != 'rtticketedit' || ConfigHelper::checkConfig('phpui.helpdesk_allow_all_users_modify_deadline')
					|| !$ticket.oldverifierid || $ticket.oldverifierid == $layout.logid}
					<INPUT TYPE="TEXT" NAME="ticket[deadline]" VALUE="{if $ticket.deadline}{$ticket.deadline|date_format:"%Y/%m/%d %H:%M"}{/if}" SIZE="20"
						{tip text="Enter deadline in YYYY/MM/DD HH:MM format or click to select it from applet" class="lms-ui-datetime" trigger="deadline"}>
				{else}
					<INPUT TYPE="hidden" NAME="ticket[deadline]" VALUE="{if $ticket.deadline}{$ticket.deadline|date_format:"%Y/%m/%d %H:%M"}{/if}">
					<span title="{trans("Only verifier can change this")}">{if $ticket.deadline}{$ticket.deadline|date_format:"%Y/%m/%d %H:%M"}{else}{trans("<!rt>- none -")}{/if}</span>
				{/if}
			{/box_row}

			{box_row icon="img/dead.gif" label="Status:"}
				<SELECT name="ticket[state]" id="state" {tip text="Select status" trigger="state"}>
					{foreach $_RT_STATES as $stateidx => $state}
					<OPTION value="{$stateidx}"{if $ticket.state == $stateidx} selected{/if}>{$state.label}</OPTION>
					{/foreach}
				</SELECT>
				&nbsp;
				<label>
					<INPUT type="checkbox" name="ticket[resolve]" id="resolve" value="{$smarty.const.RT_RESOLVED}"{if isset($message.resolve) || $message.state == $smarty.const.RT_RESOLVED} CHECKED{/if}{tip trigger="resolve"}>
					{trans("resolve ticket")}
				</label>
			{/box_row}

			{box_row icon="img/queue.gif" label="Queue:"}
				<SELECT size="1" name="ticket[queue]" {tip text="Select queue" trigger="queue"} onchange="xajax_queue_changed($(this).val(), $('#rtverifiers').val())">
					{foreach $queuelist as $item}
					<OPTION value="{$item.id}"{if $item.newticketsubject && $item.newticketbody} data-newticket-notify="1"{/if}{if $item.id == $queue} selected{/if}>{$item.name}</OPTION>
					{/foreach}
				</SELECT>
			{/box_row}

			{box_row icon="img/desc.gif" label="Cause:"}
				<SELECT size="1" name="ticket[cause]" {tip text="Select ticket cause" trigger="cause"}>
					<OPTION value="0" {if !$ticket.cause}selected{/if}>{trans("unknown/other")}</OPTION>
					<OPTION value="1" {if $ticket.cause == 1}selected{/if}>{trans("customer's side")}</OPTION>
					<OPTION value="2" {if $ticket.cause == 2}selected{/if}>{trans("company's side")}</OPTION>
				</SELECT>
			{/box_row}

			{box_row icon="img/volcano.png" label="Ticket source:"}
				<SELECT size="1" name="ticket[source]" {tip text="Select ticket source" trigger="source"}>
					{foreach $_RT_SOURCES as $sourceidx => $source}
					<OPTION value="{$sourceidx}"{if $ticket.source == $sourceidx}selected {/if}>{$source}</OPTION>
					{/foreach}
				</SELECT>
			{/box_row}

			{box_row icon="img/report.gif" label="Priority:"}
				<SELECT size="1" name="ticket[priority]" {tip text="Set ticket priority" trigger="priority"}>
					{foreach $_RT_PRIORITIES as $priorityidx => $priority}
					<OPTION value="{$priorityidx}"{if $ticket.priority == $priorityidx}selected {/if}>{$priority}</OPTION>
					{/foreach}
				</SELECT>
			{/box_row}

{if $layout.module != 'eventadd'}
			{box_row icon="img/home.gif" label="Location:"}
				{if $ticket.address_id > 0 && $customerid}
					{$selected_address_id = $ticket.address_id}
				{else}
					{$selected_address_id = null}
				{/if}
				{if $address_id_warning}
					{$class = "lms-ui-error"}
				{else}
					{$class = ""}
				{/if}
				{include file="customer/customeraddresses.html" id="customer_addresses" name="ticket[address_id]"
					trigger="address_id" selected_address_id=$selected_address_id class=$class}
				<input type="hidden" name="address_id_warning" value="{if $address_id_warning}1{else}0{/if}">
			{/box_row}
{/if}

			{$visibility=(!empty($nodes) && $layout.module != 'eventadd')}
			{box_row class="node-row" icon="img/node.gif" label="Node:" visible=$visibility}
				<select class="node-list" name="ticket[nodeid]" {tip text="Select node" trigger="nodeid"}>
					<option value="">{trans("- none -")}</option>
					{if !empty($nodes)}
						{foreach $nodes as $node}
							<option value="{$node.id}"{if $node.id == $ticket.nodeid || count($nodes) == 1} selected{/if}>{$node.name}: {$node.location}</option>
						{/foreach}
					{/if}
				</select>
			{/box_row}

			{box_row icon="img/netnode.png" label="Network node:"}
				<SELECT name="ticket[netnodeid]" size="30" {tip class="lms-ui-advanced-select" text="Select network node (optional)" trigger="netnodeid"}
						onchange="xajax_netnode_changed($(this).val(), $('#netdevid').val())">
					<OPTION value="">{trans("- none -")}</OPTION>
					{foreach $netnodelist as $idx => $netnode}
					<OPTION value="{$idx}" {if $idx == $ticket.netnodeid} selected{/if}> {$netnode.name} ({$netnode.id})</OPTION>
					{/foreach}
				</SELECT>
			{/box_row}

			{box_row icon="img/netdev.gif" label="Device:" field_id="rtnetdevs"}
				{include file="rt/rtnetdevs.html" form="ticket"}
			{/box_row}

			{box_row id="customernotify-row" icon="img/mail.gif" label="Notify customer:" labelid="customernotify"}
				<input type="checkbox" id="customernotify" name="ticket[customernotify]" value="1"{if isset($ticket.customernotify)} checked{/if}>
			{/box_row}

			{box_row icon="img/money.gif" label="Investment project:"}
				<SELECT name="ticket[invprojectid]" {tip text="Select investment projects" trigger="invprojectid"}>
					<OPTION value="">{trans("- none -")}</OPTION>
					{foreach $invprojectlist as $idx => $project}
					<OPTION value="{$idx}" {if $idx == $ticket.invprojectid} selected{/if}>
					{$project.name} ({$project.id})
					</OPTION>
					{/foreach}
				</SELECT>
			{/box_row}

			{box_row id="parent-ticket" class="ticket-list-container" icon="lms-ui-icon-parentticket" label="Parent ticket:"}
				<div class="ticket-suggestion-container">
					{button type="link" class="ticket-suggestion-button" icon="edit" href="#"}
					<input type="text" id="parentid" class="ticket-suggestion" {tip text="Enter ID of parent ticket" trigger="parentid"}>
				</div>
				<ul class="ticket-list"{if !$ticket.parent} style="display: none;"{/if}>
					{if $ticket.parent}
						<li data-ticket-id="{$ticket.parent.ticketid}">
							<input type="hidden" name="ticket[parentid]" value="{$ticket.parent.ticketid}">
							<i class="lms-ui-icon-delete ticket-unlink"></i>#{$ticket.parent.ticketid|string_format:"%06d"} <A href="?m=rtticketview&id={$ticket.parent.ticketid}">{$ticket.parent.subject}</A>
						</li>
					{/if}
			{/box_row}

			{box_row id="related-tickets" class="ticket-list-container" icon="lms-ui-icon-relatedticket" label="Related tickets:"}
				<div class="ticket-suggestion-container">
					{button type="link" class="ticket-suggestion-button" icon="edit" href="#"}
					<input type="text" class="ticket-suggestion" {tip text="Enter ticket identifier or ticket subject part"}>
				</div>
				<ul class="ticket-list"{if !$ticket.relatedtickets} style="display: none;"{/if}>
					{if $ticket.relatedtickets}
						{foreach $ticket.relatedtickets as $i}
							<li data-ticket-id="{$i.id}">
								<input type="hidden" name="ticket[relatedtickets][{$i.id}]" value="{$i.id}">
								<i class="lms-ui-icon-delete ticket-unlink"></i>#{$i.id|string_format:"%06d"} <A href="?m=rtticketview&id={$i.id}">{$i.subject}</A>
							</li>
						{/foreach}
					{/if}
				</ul>
			{/box_row}
			{/block}
{/box_panel}
	{/box_contents}

	{if $layout.module != 'eventadd'}
	{box_buttons}
		{button type="submit" icon="save" accesskey="s" label="Submit"}
		{button icon="cancel" onclick="location.href = '?m=rtqueueview{if isset($backid)}#{$backid}{/if}'"
			label="Cancel"}
	{/box_buttons}
	{/if}
{/box_container}

<script src="js/templates/rt/rtticketmodify.js"></script>
<script>

	$(function() {
		$('#resolve').change(function() {
			var stateelem = $('#state');
			if ($(this).prop('checked')) {
				$(this).data('prev-state', stateelem.val());
				stateelem.val({$smarty.const.RT_RESOLVED});
			} else {
				var prev_state = $(this).data('prev-state');
				if (prev_state) {
					stateelem.val(prev_state);
				}
			}
		});

		$('#state').change(function() {
			$('#resolve').prop('checked', $(this).val() == {$smarty.const.RT_RESOLVED});
		});

		$('body').on('change', '.template-selector', function() {
			var selected = $('option:selected', this);
			if (parseInt(selected.val()) == 0) {
				return;
			}
			$('[name="ticket[subject]"]').val(Base64.decode(selected.attr('data-subject')));
			$($(this).attr('data-target')).val(Base64.decode(selected.attr('data-message')));
		});

		(function() {
			var parent_ticket = $('#parent-ticket');
			var ticket_list = parent_ticket.find('.ticket-list');
			var ticket_suggestion = parent_ticket.find('.ticket-suggestion');
			new AutoSuggest(
					parent_ticket.closest('form')[0], ticket_suggestion[0],
					'?m=quicksearch&ajax=1&mode=ticket&what=', 0,
					function (data) {
						ticket_suggestion.val('');
						var html = '<li data-ticket-id="' + data.id + '">' +
								'<input type="hidden" name="ticket[parentid]" value="' + data.id + '">' +
								'<i class="lms-ui-icon-delete ticket-unlink"></i>' +
								sprintf("#%06d", data.id) + ' <a href="?m=rtticketview&id=' + data.id + '">' +
								data.name + '</a></li>';
						ticket_list.html(html).show();
					},
					function (suggestions) {
						var result = [];
						var ticketids = [];
						$('li[data-ticket-id]').each(function () {
							ticketids.push($(this).attr('data-ticket-id'));
						});
						{if isset($ticket.ticketid)}
							ticketids.push('{$ticket.ticketid}');
						{/if}
						$.each(suggestions, function (key, suggestion) {
							if (ticketids.indexOf(suggestion.id) == -1) {
								result.push(suggestion);
							}
						});
						return result;
					}
			);
		})();

		(function() {
			var related_tickets = $('#related-tickets');
			var ticket_list = related_tickets.find('.ticket-list');
			var ticket_suggestion = related_tickets.find('.ticket-suggestion');
			new AutoSuggest(
					related_tickets.closest('form')[0], ticket_suggestion[0],
					'?m=quicksearch&ajax=1&mode=ticket&what=', 0,
					function (data) {
						ticket_suggestion.val('');
						var html = '<li data-ticket-id="' + data.id + '">' +
								'<input type="hidden" name="ticket[relatedtickets][' + data.id + ']" value="' + data.id + '">' +
								'<i class="lms-ui-icon-delete ticket-unlink"></i>' +
								sprintf("#%06d", data.id) + ' <a href="?m=rtticketview&id=' + data.id + '">' +
								data.name + '</a></li>';
						ticket_list.append(html).show();
					},
					function (suggestions) {
						var result = [];
						var ticketids = [];
						$('li[data-ticket-id]').each(function () {
							ticketids.push($(this).attr('data-ticket-id'));
						});
						{if isset($ticket.ticketid)}
							ticketids.push('{$ticket.ticketid}');
						{/if}
						$.each(suggestions, function (key, suggestion) {
							if (ticketids.indexOf(suggestion.id) == -1) {
								result.push(suggestion);
							}
						});
						return result;
					}
			);
		})();

		$('.ticket-list-container').on('click', '.ticket-unlink', function () {
			var list_elem = $(this).closest('li');
			var ticket_list = $(this).closest('.ticket-list');
			list_elem.remove();
			ticket_list.toggle(ticket_list.find('li').length > 0);
		}).find('.ticket-suggestion-container a').click(function() {
			$(this).hide().next().show().focus().closest('.lms-ui-box-row-field').css('flex-direction', 'column')
				.find('ul').css('margin-block-start', '0.5em');
		}).end().find('.ticket-suggestion-container input').focusout(function() {
			$(this).hide().prev().show().closest('.lms-ui-box-row-field').css('flex-direction', 'row')
				.find('ul').css('margin-block-start', '0');
		});

	});

</script>
