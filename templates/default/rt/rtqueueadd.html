{extends file="layout.html"}
{block name=title}LMS: {$layout.pagetitle|striphtml}{/block}
{block name=module_content}
<!--// $Id$ //-->

<style>

	fieldset {
		margin-top: 2em;
		margin-right: 2em;
		margin-bottom: 2em;
		vertical-align: top;
	}

	#left-panel {
		display: inline-block;
		margin-right: 2em;
	}

</style>

<H1>{$layout.pagetitle}</H1>
<FORM METHOD="POST" NAME="queue" ACTION="?m=rtqueueadd">
<INPUT type="submit" class="hiddenbtn">
<TABLE class="lmsbox">
	<COLGROUP>
		<COL style="width: 50%">
		<COL style="width: 50%">
	</COLGROUP>
    <THEAD>
	<TR>
		<TD class="nobr">
			<TABLE cellpadding="1">
				<COLGROUP>
					<COL style="width: 1%;">
					<COL style="width: 1%;">
					<COL style="width: 98%;">
				</COLGROUP>
				<TR>
					<TD>
						<i class="lms-ui-icon-content lms-ui-icon-queue"></i>
					</TD>
					<TD class="bold">{trans("Name:")}</TD>
					<TD>
						<INPUT TYPE="TEXT" NAME="queue[name]" VALUE="{$queue.name}" {tip text="Enter name" trigger="name" bold=1}>
					</TD>
				</TR>
			</TABLE>
		</TD>
	</TR>
    </THEAD>
    <TBODY>
	<TR>
		<TD class="container">
			<TABLE cellpadding="1">
				<COLGROUP>
					<COL style="width: 40%">
					<COL style="width: 10%">
					<COL style="width: 50%">
				</COLGROUP>
				<TR>
					<TD class="valign-top">
						<TABLE cellpadding="3" id="left-panel">
							<COLGROUP>
								<COL style="width: 1px;">
								<COL style="width: 1px;">
								<COL style="width: 98px;">
							</COLGROUP>
							<TR>
								<TD>
									<i class="lms-ui-icon-content lms-ui-icon-mail"></i>
								</TD>
								<TD class="bold">{trans("E-mail")}:</TD>
								<TD>
									<INPUT TYPE="email" SIZE="50" NAME="queue[email]" VALUE="{$queue.email}" {tip text="Enter e-mail address" trigger="email"}>
								</TD>
							</TR>
							<TR>
								<TD>
									<i class="lms-ui-icon-content lms-ui-icon-description"></i>
								</TD>
								<TD class="bold">{trans("Description")}:</TD>
								<TD>
									<TEXTAREA NAME="queue[description]" COLS="50" ROWS="3" {tip text="Enter additional information (optional)"}>{$queue.description}</TEXTAREA>
								</TD>
							</TR>
                            <TR>
                                <TD class="bold nobr">
                                    <i class="lms-ui-icon-content lms-ui-icon-verifier"></i>
                                </TD>
								<TD class="bold">{trans("<!rt>Verifier:")}</TD>
                                <TD>
                                    <SELECT size="1" name="queue[verifierid]" {tip text="Select user" trigger="verifierid"}>
                                        <OPTION value="">- {trans("select user")} -</OPTION>
                                        {foreach $userlist as $user}
                                        <OPTION value="{$user.id}" {if $user.id == $queue[verifierid]} selected{/if}>{$user.rname} ({$user.login})</OPTION>
                                        {/foreach}
                                    </SELECT>
                                </TD>
                            </TR>
							<TR>
								<TD>
									<i class="lms-ui-icon-content lms-ui-icon-user"></i>
								</TD>
								<TD class="bold">{trans("Permissions:")}</TD>
								<TD>
									<TABLE class="lmsbox lms-ui-background-cycle">
										<COLGROUP>
											<COL style="width: {100-count($_RT_RIGHTS)}%;">
											{foreach $_RT_RIGHTS as $label}
											<COL style="width: 1%;">
											{/foreach}
										</COLGROUP>
										<THEAD>
											<TR>
												<TD class="bold">{trans("User")}</TD>
												{foreach $_RT_RIGHTS as $label}
												<TD class="bold text-center nobr">{$label}</TD>
												{/foreach}
											</TR>
										</THEAD>
										<TBODY>
											{foreach from=$queue.rights item=right}
											<TR class="highlight lms-ui-row-all-check">
												<TD class="nobr">
													<A href="?m=userinfo&amp;id={$right.id}">{$right.rname} ({$right.login})</A>
													<INPUT type="hidden" name="queue[usernames][{$right.id}]" value="{$right.name}">
												</TD>
												{foreach $_RT_RIGHTS as $rightvalue => $label}
												<TD class="text-center">
													<INPUT type="checkbox" name="queue[users][{$right.id}][{$rightvalue}]" value="{$rightvalue}"{if ($right.rights & $rightvalue) == $rightvalue} checked{/if}>
												</TD>
												{/foreach}
											</TR>
											{/foreach}
											<TR class="highlight">
												<TD class="nobr text-right">
													{trans("Check All")}
												</TD>
												{foreach $_RT_RIGHTS as $rightvalue => $label}
												<TD class="text-center">
													<INPUT TYPE="checkbox" NAME="allbox[{$rightvalue}]" data-value="{$rightvalue}">
												</TD>
												{/foreach}
											</TR>
										</TBODY>
									</TABLE>
								</TD>
							</TR>
							<tr>
								<td colspan="2">
								</td>
								<td>
									<FIELDSET>
										<LEGEND><i class="lms-ui-icon-content lms-ui-icon-queue"></i><span class="bold">{trans("Default categories")}</span>
											<input type="checkbox" id="checkall">
										</LEGEND>
										<table>
											<tr>
												<td>
													{include file="rt/rtcategoryselection.html" id="categories" name_prefix="queue[categories]" categories=$categories}
												</td>
											</tr>
										</table>
									</FIELDSET>
								</td>
							</tr>
						</TABLE>
						<fieldset>
							<legend>{icon name="notifications"} <strong>{trans("Customer notifications")}</strong></legend>
							<div id="notification-tabs">
								<ul>
									<li><a href="#notification-tab-email">{trans("Email")}</a></li>
									<li><a href="#notification-tab-sms">{trans("SMS")}</a></li>
								</ul>
								<div id="notification-tab-email" class="notification-tab">
									<TABLE cellpadding="3">
										<TR>
											<TD class="bold valign-top">
												{trans("Subject (new ticket)")}
											</TD>
										</TR>
										<tr>
											<TD class="valign-top">
												{capture assign="tip"}{trans("Subject of mail sent after new ticket is created")}<br><br>{trans("<!customer-notification-subject>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
												<INPUT type="text" name="queue[newticketsubject]" value="{$queue.newticketsubject}"
													size="60" {tip text=$tip trigger="newticketsubject"}>
											</TD>
										</tr>
										<TR>
											<TD class="bold valign-top">
												{trans("Body (new ticket)")}
											</TD>
										</TR>
										<TR>
											<TD class="valign-top">
												{capture assign="tip"}{trans("Body of mail sent after new ticket is created")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
												<TEXTAREA name="queue[newticketbody]" cols="60" rows="10"
													{tip text=$tip trigger="newticketbody"}
													>{$queue.newticketbody}</TEXTAREA>
											</TD>
										</TR>
										<TR>
											<TD class="bold valign-top">
												{trans("Subject (new message)")}
											</TD>
										<TR>
											<TD class="valign-top">
												{capture assign="tip"}{trans("Subject of mail sent after new message is added")}<br><br>{trans("<!customer-notification-subject>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
												<INPUT type="text" name="queue[newmessagesubject]" value="{$queue.newmessagesubject}"
													size="60" {tip text=$tip trigger="newmessagesubject"}>
											</TD>
										</TR>
										<TR>
											<TD class="bold valign-top">
												{trans("Body (new message)")}
											</TD>
										</TR>
										<TR>
											<TD class="valign-top">
												{capture assign="tip"}{trans("Body of mail sent after new message is added")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
												<TEXTAREA name="queue[newmessagebody]" cols="60" rows="10"
													{tip text=$tip trigger="newmessagebody"}
													>{$queue.newmessagebody}</TEXTAREA>
											</TD>
										</TR>
										<TR>
											<TD class="bold valign-top">
												{trans("Subject (resolve ticket)")}
											</TD>
										</TR>
										<TR>
											<TD class="valign-top">
												{capture assign="tip"}{trans("Subject of mail sent after ticket is resolved")}<br><br>{trans("<!customer-notification-subject>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
												<INPUT type="text" name="queue[resolveticketsubject]" value="{$queue.resolveticketsubject}"
													size="60" {tip text=$tip trigger="resolveticketsubject"}>
											</TD>
										</TR>
										<TR>
											<TD class="bold valign-top">
												{trans("Body (resolve ticket)")}
											</TD>
										</TR>
										<TR>
											<TD class="valign-top">
												{capture assign="tip"}{trans("Body of mail sent after ticket is resolved")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
												<TEXTAREA name="queue[resolveticketbody]" cols="60" rows="10"
													{tip text=$tip trigger="resolveticketbody"}
													>{$queue.resolveticketbody}</TEXTAREA>
											</TD>
										</TR>
									</TABLE>
								</div>
								<div id="notification-tab-sms" class="notification-tab">
									<TABLE cellpadding="3">
										<TR>
											<TD class="bold valign-top">
												{trans("Body (new ticket)")}
											</TD>
										</TR>
										<TR>
											<TD class="valign-top">
												{capture assign="tip"}{trans("SMS sent after new ticket is created")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
												<TEXTAREA name="queue[newticketsmsbody]" cols="60" rows="10"
													{tip text=$tip trigger="newticketsmsbody"}
													>{$queue.newticketsmsbody}</TEXTAREA>
											</TD>
										</TR>
										<TR>
											<TD class="bold valign-top">
												{trans("Body (new message)")}
											</TD>
										</TR>
										<TR>
											<TD class="valign-top">
												{capture assign="tip"}{trans("SMS sent after new message is added")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
												<TEXTAREA name="queue[newmessagesmsbody]" cols="60" rows="10"
													{tip text=$tip trigger="newmessagesmsbody"}
													>{$queue.newmessagesmsbody}</TEXTAREA>
											</TD>
										</TR>
										<TR>
											<TD class="bold valign-top">
												{trans("Body (resolve ticket)")}
											</TD>
										</TR>
										<TR>
											<TD class="valign-top">
												{capture assign="tip"}{trans("SMS sent after ticket is resolved")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
												<TEXTAREA name="queue[resolveticketsmsbody]" cols="60" rows="10"
													{tip text=$tip trigger="resolveticketsmsbody"}
													>{$queue.resolveticketsmsbody}</TEXTAREA>
											</TD>
										</TR>
									</TABLE>
								</div>
							</div>
						</fieldset>
						<fieldset>
							<legend>{icon name="verifier"} <strong>{trans("Verifier notifications")}</strong></legend>
							<table>
								<tr>
									<td>
										{trans("Subject (ticket verifier)")}
									</td>
								</tr>
								<TR>
									<TD class="valign-top">
										{capture assign="tip"}{trans("Subject of mail sent to verifier after ticket is transferred to him")}<br><br>{trans("<!customer-notification-subject>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
										<INPUT type="text" name="queue[verifierticketsubject]" value="{$queue.verifierticketsubject}"
											size="60" {tip text=$tip trigger="verifierticketsubject"}>
									</TD>
								</TR>
								<TR>
									<TD class="bold valign-top">
										{trans("Body (ticket verifier)")}
									</TD>
								</TR>
								<TR>
									<TD class="valign-top">
										{capture assign="tip"}{trans("Body of mail sent to verifier after ticket is transferred to him")}<br><br>{trans("<!customer-notification-body>The following special symbols are supported:<br><strong>%tid</strong> - ticket identifier,<br><strong>%cid</strong> - customer identifier,<br><strong>%pin</strong> - customer PIN,<br><strong>%customername</strong> - customer full name,<br><strong>%title</strong> - ticket title.<br>")}{/capture}
										<TEXTAREA name="queue[verifierticketbody]" cols="60" rows="10"
											{tip text=$tip trigger="verifierticketbody"}
											>{$queue.verifierticketbody}</TEXTAREA>
									</TD>
								</TR>
							</table>
						</fieldset>
					</TD>
				</TR>
			</TABLE>
		</TD>
	</TR>
	<TR>
		<TD class="lms-ui-box-buttons">
			{button id="submit-button" type="submit" icon="save" label="Submit" onclick="javascript:document.queue.submit();"}
			{button icon="cancel" label="Cancel" onclick="location.href='?m=rtqueuelist';"}
		</TD>
	</TR>
    </TBODY>
</TABLE></FORM>
<script>

	$(function() {
		$('form[name="queue"] [name="queue[name]"]').focus();

		for (var i = 0; i < {count($_RT_RIGHTS)}; i++) {
			$('input:checkbox[name="allbox[' + Math.pow(2, i) + ']"]').click(function() {
				$('input:checkbox[name*="queue[users]"][value="' + $(this).attr('data-value') + '"]').prop('checked', this.checked);
			});
		}

		$('#checkall').click(function() {
			$('#categories option').attr('selected', $(this).prop('checked')).trigger('chosen:updated');
		});

		var categories = $('#categories option');
		$('#checkall').prop('checked', categories.length == categories.filter(':selected').length);
		$('#categories').change(function() {
			$('#checkall').prop('checked', categories.length == categories.filter(':selected').length);
		});

		$('[name="queue"]').submit(function() {
			window.sessionStorage.setItem('rtqueuemodify-active-notification-tab', $('.notification-tab:visible').attr('id'));
		});

		var activeNotificationTab = window.sessionStorage.getItem('rtqueuemodify-active-notification-tab');
		if (activeNotificationTab) {
			window.sessionStorage.removeItem('rtqueuemodify-active-notification-tab');
		}

		var errors = [];
		$('.notification-tab').each(function() {
			if ($(this).find('.lms-ui-error').length) {
				errors.push($(this).attr('id'));
			}
		});

		var newActiveNotificationTab;

		if (activeNotificationTab) {
			newActiveNotificationTab = activeNotificationTab;
		}
		if (errors.length && errors.indexOf(activeNotificationTab) == -1) {
			newActiveNotificationTab = errors[0];
		}

		if (newActiveNotificationTab) {
			newActiveNotificationTab = $('.notification-tab').index('#' + newActiveNotificationTab);
		} else {
			newActiveNotificationTab = $('.notification-tab').first();
		}
		$('#notification-tabs').tabs({
			active: newActiveNotificationTab
		});

		$.each(errors, function(index, value) {
			$('[href="#' + value + '"]').closest('.ui-tab').addClass('lms-ui-error');
		});
	});

</script>
{/block}
