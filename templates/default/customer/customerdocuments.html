<!--// $Id$ //-->

<form method="POST" name="customerdocuments" id="customerdocuments-form">
</form>

{tab_container id="customerdocuments"}

	{tab_header content_id="docpanel"}
		{tab_header_cell icon="fas fa-file-alt"}
			<strong>{trans("Customer's Documents:")}</strong> ({t a=$limit}last $a documents{/t})
		{/tab_header_cell}
		{tab_header_cell}
			<A href="?m=documentadd&cid={$customerinfo.id}">{trans("New Document")} &raquo;</A>
			<A href="?m=documentlist&c={$customerinfo.id}">{trans("All Documents")} &raquo;</A>&nbsp;
		{/tab_header_cell}
	{/tab_header}

	{tab_contents id="docpanel"}

		{tab_table}
			<TABLE class="lms-ui-tab-table">
				<COLGROUP>
					<COL style="width: 10%;">
					<COL style="width: 10%;">
					<COL style="width: 10%;">
					<COL style="width: 10%;">
					<COL style="width: calc(50%-10em);">
					<COL style="width: 10%;">
					<COL style="width: 10em;">
				</COLGROUP>
				{if $documents}
				<THEAD>
					<TR>
						<TD><strong>{trans("Number:")}</strong></TD>
						<TD>{trans("Creation date<!document>")} / {trans("Confirmation date<!document>")}:</TD>
						<TD>{trans("Created by<!document>")} / {trans("Confirmed by<!document>")}:</TD>
						<TD><strong>{trans("Type:")}</strong></TD>
						<TD>{trans("Title:")}</TD>
						<TD>{trans("Period:")}</TD>
						<TD></TD>
					</TR>
				</THEAD>
				{/if}
				<TBODY>
					{foreach $documents as $doc}
					<TR class="{if $doc.closed} blend{/if}">
						<TD onclick="window.open('?m=documentview&amp;id={$doc.docid}');"{if $doc.description} {tip text=$doc.description}{/if}>
							<strong>{number number=$doc.number template=$doc.template time=$doc.cdate}</strong>
						</TD>
						<TD onclick="window.open('?m=documentview&amp;id={$doc.docid}');">
							{$doc.cdate|date_format:"%Y/%m/%d %H:%M"}{if $doc.sdate} / {$doc.sdate|date_format:"%Y/%m/%d %H:%M"}{/if}
						</TD>
						<TD onclick="window.open('?m=documentview&amp;id={$doc.docid}');">
							{$doc.username}{if $doc.cusername} / {$doc.cusername}{/if}
						</TD>
						<TD onclick="window.open('?m=documentview&amp;id={$doc.docid}');">
							<strong>{assign var=type value=$doc.type}{$_DOCTYPES.$type}</strong>
						</TD>
						<TD onclick="window.open('?m=documentview&amp;id={$doc.docid}');">{$doc.title|truncate:40:"...":true}</TD>
						<TD onclick="window.open('?m=documentview&amp;id={$doc.docid}');">
							{if $doc.fromdate}{trans("from")} {$doc.fromdate|date_format:"%Y/%m/%d"}{/if}
							{if $doc.todate}{trans("to")} {$doc.todate|date_format:"%Y/%m/%d"}{/if}
						</TD>
						<TD>
							{if $customerinfo.senddocuments}
								<a class="documentsend lms-ui-mail-button" href="?m=documentsend&id={$doc.docid}"><i title="{trans("Document send")}"></i></a>
							{/if}
							{assign var=type value=$doc.type}
							<a class="lms-ui-save-button" href="?m=documentview&amp;id={$doc.docid}&amp;save=1"><i title="{trans("Save")}"></i></a>
							{if ! $doc.closed && ($docrights.$type.rights & 4)}
								<a class="lms-ui-confirm-button" href="?m=documentedit&amp;id={$doc.docid}&amp;action=confirm"><i title="{trans("Confirm")}"></i></a>
							{/if}
							{if ($docrights.$type.rights & 16)}
							<a class="lms-ui-delete-button" onclick="return confirmLink(this, '{trans("Are you sure, you want to remove that document?")}')" href="?m=documentdel&amp;id={$doc.docid}" {tip text="Remove document"}>
								<i title="{trans("Delete")}"></i>
							</a>
							{/if}
							{if ($docrights.$type.rights & 8)}
							<a class="lms-ui-edit-button" href="?m=documentedit&amp;id={$doc.docid}">
								<i title="{trans("Edit")}"></i>
							</a>
							{/if}
							{$docattach = $doc.attachments[0]}
							{if $docattach.main || count($doc.attachments) == 1}
							{documentview id="{$doc.docid}-{$docattach.id}" type=$docattach.contenttype name=$docattach.filename
								url="?m=documentview&id={$doc.docid}" external=true
								text="<i class=\"{if preg_match('/pdf/',$docattach.contenttype)}pdf{elseif preg_match('/csv|excel|spreadsheet/',$docattach.contenttype)}xls{/if}\"></i>"}
							{/if}
							{if count($doc.attachments) > 1}
							<a href="#" id="allattachments-toggle-{$doc.docid}" onclick="toggle_all_attachments({$doc.docid}); return false;" title="{trans("more document attachments")}">
								<img src="img/asc_order.gif">
							</a>
							{/if}
							<INPUT TYPE="checkbox" NAME="marks[{$doc.docid}]" form="customerdocuments-form" class="lms-ui-multi-check" VALUE="{$doc.docid}">
							<div id="allattachments-{$doc.docid}" style="display: none;">
								{foreach $doc.attachments as $docattach}
								{if $docattach@first && $docattach.main}{continue}{/if}
								{documentview id="{$doc.docid}-{$docattach.id}" type=$docattach.contenttype name=$docattach.filename
									url="?m=documentview&id={$doc.docid}&attachmentid={$docattach.id}" external=true
									text="{$docattach.filename} <i class=\"{if preg_match('/pdf/',$docattach.contenttype)}pdf{elseif preg_match('/csv|excel|spreadsheet/',$docattach.contenttype)}xls{/if}\"></i>"}
								<br>
								{/foreach}
							</div>
						</TD>
					</TR>
					{foreachelse}
					<TR>
						<TD class="lms-ui-tab-table-empty" colspan="7">
							{trans("That customer hasn't got any documents.")}
						</TD>
					</TR>
					{/foreach}
				</TBODY>
			</TABLE>
		{/tab_table}

{if count($documents)}
		{tab_button_panel}
			{tab_buttons}
				<button type="button" class="lms-ui-button lms-ui-mail-button" onclick="return confirm('{trans("Are you sure, you want to send documents to customer?")}')">
					<i></i> {trans("Send documents")}
				</button>
				<button type="button" class="lms-ui-button lms-ui-print-button" onclick="javascript:print_docs();">
					<i></i> {trans("Print")}
				</button>
				<button type="button" class="lms-ui-button lms-ui-confirm-button" onclick="javascript:mark_docs();">
					<i></i> {trans("Confirm")}
				</button>
				<button type="button" class="lms-ui-button lms-ui-delete-button" onclick="javascript:delete_docs();">
					<i></i> {trans("Delete")}
				</button>
			{/tab_buttons}
			{tab_buttons}
				<label>
					{trans("Check All")}
					<INPUT TYPE="checkbox" class="lms-ui-multi-check-all" VALUE="1">
				</label>
			{/tab_buttons}
		{/tab_button_panel}
{/if}

	{/tab_contents}
{/tab_container}

<SCRIPT>

	function toggle_all_attachments(docid) {
		var elem = $('#allattachments-' + docid);
		var toggle = $('#allattachments-toggle-' + docid);
		elem.toggle();
		if (elem.is(':visible'))
			toggle.html('<img src="img/desc_order.gif">');
		else
			toggle.html('<img src="img/asc_order.gif">');
	}

	function delete_docs() {
		if (!confirm('{trans("Are you sure, you want to delete selected documents?")}'))
			return;

		document.customerdocuments.action="?m=documentdel&is_sure=1";
		document.customerdocuments.target="";
		document.customerdocuments.submit();
	}

	function print_docs() {
		document.customerdocuments.action="?m=documentview";
		document.customerdocuments.target="_blank";
		document.customerdocuments.submit();
	}

	function mark_docs() {
		document.customerdocuments.action="?m=documentedit&action=confirm";
		document.customerdocuments.target="";
		document.customerdocuments.submit();
	}

	function send_documents() {
		document.customerdocuments.action="?m=documentsend";
		document.customerdocuments.target="_blank";
		document.customerdocuments.submit();
	}

	$('.documentsend').click(function() {
		if (!confirm('{trans("Are you sure, you want to send document to customer?")}')) {
			return false;
		}
		window.open($(this).attr('href'));
		return false;
	});

</SCRIPT>
