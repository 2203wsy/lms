{extends file="layout.html"}
{block name=title}LMS: {$layout.pagetitle|striphtml}{/block}
{block name=module_content}
<!--// $Id$ //-->
<style>

	audio {
		height: 2em;
	}

	ul.customer-list {
		margin-block-start: 0.1em;
		margin-block-end: 0.1em;
		list-style: none;
		padding-inline-start: 1em;
	}

	.customer-call-edit {
		display: none;
	}

	.customer-call-note {
		min-height: 1.5em;
	}

</style>

<h1>{$layout.pagetitle}</h1>
<table class="lmsbox">
	<colgroup>
		<col style="width: 99%;">
		<col style="width: 1%;">
	</colgroup>
	<thead>
		<tr>
			<td class="hand">
				{icon name="phone-call" class="fa-fw"}
				<strong>{trans("Customer Phone Calls")}</strong>
			</td>
			<td>
				&nbsp;
			</td>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td style="width: 100%;" colspan="2">
				<table class="lmsbox-inner lms-ui-background-cycle">
					<colgroup>
						<col style="width: 13%;">
						<col style="width: 15%;">
						<col style="width: 12%;">
						<col style="width: 12%;">
						<col style="width: 13%;">
						<col style="width: 20%;">
						<col style="width: 15%;">
					</colgroup>
					<thead>
						<tr class="fbottom">
							<td class="nobr">
								<strong>{trans("Date")}</strong>
							</td>
							<td class="nobr">{trans("User")}</TD>
							<td class="nobr">{trans("Duration")}</TD>
							<td class="nobr">{trans("Type")}</TD>
							<td class="nobr">
								<strong>{trans("Phone number")}</strong>
							</td>
							<td class="nobr">
								{trans("Notes")}
							</td>
							<td></td>
						</tr>
					</thead>
					<tbody>
						{foreach $customercalls as $call}
							<tr class="highlight customer-call" data-call-id="{$call.id}">
								<td class="nobr">
									<strong>{$call.dt|date_format:"%Y/%m/%d %H:%M:%S"}</strong>
								</td>
								<td class="nobr">
									{$call.username|default:"-"|escape}
								</td>
								<td class="nobr">
									{if $call.duration == -1}
										{trans("- unknown -")}
									{else}
										{$call.duration|duration_format}
									{/if}
								</td>
								<td class="nobr">
									{capture assign="direction"}{if $call.outgoing}{trans("<!customer-call>outgoing")}{else}{trans("<!customer-call>incoming")}{/if}{/capture}
									{$direction}
								</td>
								<td class="nobr">
									<strong>{$call.phone}</strong>
									{if !empty($call.customers)}
										<ul class="customer-list">
											{foreach $call.customers as $customer}
												<li>
													<a href="?m=customerinfo&id={$customer.id}">{$customer.lastname|escape} {$customer.name|escape}</a>
												</li>
											{/foreach}
										</ul>
									{/if}
								</td>
								<td>
									<span class="customer-call-view customer-call-note-view">
										{if $call.notes}
											{$call.notes|trunescape:50|@nl2br}
										{else}
											-
										{/if}
									</span>
									<span class="customer-call-view customer-call-note-more"
										{if mb_strlen($call.notes) <= 50} style="display: none;"{/if}>
										{hint mode="toggle" icon="view" class="customer-call-note-hint" text=nl2br($call.notes)}
									</span>
									<span class="customer-call-edit" style="display: none;">
										<textarea type="text" class="customer-call-note lms-ui-autogrow"
											data-original-value="{$call.notes|escape}"
											>{$call.notes|escape}</textarea>
									</span>
								</td>
								<td class="buttons nobr">
									<audio src="?m=customercall&id={$call.id}" controls controlsList="nodownload"
										   preload="none">
										{trans("Your browser does not support the audio element.")}
									</audio>
									{if ConfigHelper::checkPrivilege('customer_call_management')}
										{button type="link" icon="edit" tip="Edit" class="customer-call-view customer-call-edit-button"}
										{button type="link" icon="save" tip="Save" class="customer-call-edit customer-call-save-button"}
										{button type="link" icon="cancel" tip="Cancel" class="customer-call-edit customer-call-cancel-button"}
									{/if}
									{button type="link" icon="download" tip="<!customer-call>Download"
										href="?m=customercall&id={$call.id}"
										download="{trans("phone-call")}-{$direction}-{$call.dt|date_format:"%Y_%m_%d_%H_%M_%S"}-{$call.phone}"}
									{if ConfigHelper::checkPrivilege('customer_call_management')}
										{button type="link" icon="delete" tip="Delete"
											href="?m=customercall&id={$call.id}&cid={$customerinfo.id}&delete"}
									{/if}
								</td>
							</tr>
						{foreachelse}
							<tr>
								<td class="empty-table" colspan="7">
									<p>{trans("That customer hasn't got any phone calls.")}</p>
								</td>
							</tr>
						{/foreach}
					</tbody>
				</table>
			</td>
		</tr>
	</tbody>
</table>
<script>

	$(function() {
		$('audio').on('play', function() {
			$('audio').not(this).each(function() {
				this.pause();
			});
		});

		$('.customer-call-note').keypress(function(e) {
			switch (e.key) {
/*
				case 'Enter':
					$(this).closest('.customer-call').find('.customer-call-save-button.lms-ui-button').click();
					break;
*/
				case 'Escape':
					$(this).closest('.customer-call').find('.customer-call-cancel-button.lms-ui-button').click();
					break;
			}
		});

		$('.customer-call-view.lms-ui-button').click(function() {
			var row = $(this).closest('.customer-call');
			row.find('.customer-call-edit,.customer-call-view:not(.customer-call-note-more)').toggle();
			row.find('.customer-call-note').trigger('input');
		});

		$('.customer-call-edit.lms-ui-button').click(function() {
			var row = $(this).closest('.customer-call');
			var notesInput = row.find('.customer-call-note');
			var notes = notesInput.val();
			if ($(this).is('.customer-call-save-button')) {
				$.ajax({
					url: "?m=customercall&edit=1",
					dataType: "json",
					method: "POST",
					data: {
						callid: row.attr('data-call-id'),
						notes: notes
					}
				}).always(function() {
					row.find('.customer-call-edit,.customer-call-view:not(.customer-call-note-more').toggle();
				}).done(function() {
					row.find('.customer-call-note-more').toggle(notes.length >= 50);
					row.find('.customer-call-note-view').html(notes.length ? escapeHtml(notes.substring(0, 50)).replace(/\n/g, '<br>') + (notes.length > 50 ? '&hellip;' : '') : '-');
					if (notes.length >= 50) {
						row.find('.customer-call-note-hint').attr('data-hint', escapeHtml(notes).replace(/\n/g, '<br>')).removeAttr('data-init');
					}
					notesInput.attr('data-original-value', escapeHtml(notes));
				});
			} else {
				row.find('.customer-call-edit,.customer-call-view:not(.customer-call-note-more)').toggle();
				row.find('.customer-call-note-more').toggle(notesInput.attr('data-original-value') >= 50);
				notesInput.val(notesInput.attr('data-original-value'));
			}
		});
	});

</script>
{/block}
